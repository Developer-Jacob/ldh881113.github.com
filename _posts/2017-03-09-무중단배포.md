---
layout: post
title: "[공부하자] L7 Health Check, 무중단 배포…"
description: "배포 관련 부족한 부분에 대한 정리 필요성을 느낌"
date: 2017-03-10
tags: [배포, 공부하자, 서버, Health Check, 무중단배포]
comments: true
share: true
---
### 배포 작업에 많이 참여하지 못해 개념적 개발적 정리가 필요했기에 다시 공부하며 정리한다.  이후 잘못되거나 부족한 부분에 대한 피드백을 채워넣겟다.

## 무중단 배포란 
 배포 도중 웹 서비스의 중단이 없이 배포가 이루어 지도록 하는 방법이다.
 배포를 진행하며 여러 대의 서버에 각각 배포가 순차적으로 이루어 진다. 현재 배포가 진행되는 서버에 클라이언트가 접속을 시도하면 문제가 생기게 된다. 이를 해결하여 서비스를 중단하지 않고 순차적으로 배포가 이루어 지게 해는 것을 무중단 배포라 한다.


## L7 HealthCheck 방식을 사용하는 무중단 배포 방법(현재 사용 중인 방법)
1. 파일을 삭제, 리네임 하는 방식으로 L4에서 HealthCheck시 404 응답코드가 이루어지게 한다.
2. 404가 떨어지면 L4의 로드밸런싱에 의해 404응답코드를 반환하는 즉 배포중인 서버를 제외한 서버를 향하게 된다.
3. 서버가 가진 세션의 관리가 필요한 경우도 있지만 현재 레디스를 통한 세션관리가 이루어 지기 때문에 이는 제외한다.
4. 배포가 이루어지면 삭제, 리네임한 파일을 원복하여 접속이 가능하게 하고 200 OK의 응답이 이루어 지게 한다. 배포가 끝난 서버는 다시 정상적인 운영이 진행된다.
5. 배포가 끝난 서버라도 재시작의 시간이 일부 존재하기 때문에 슬립이 필요하다. 약 30초가량
6. 다음 서버가 1~5의 방법을 진행한다.
7. 이와 같은 방법으로 전체 서버가 순차적으로 진행하게 되고 무중단으로 배포가 이루어 진다.

## HealthCheck란 (Real Server HealthCheck)
* 헬스체크란 서버가 죽었는지 살았는지는 확인하는 것이다. L2(스위치), L3, L4, L7을 활용하여 지속적으로 서버에 접근을 시도한다. 이에 제대로 된 응답이 오는 것을 확인하여 HealthCheck가 이루어진다.
 
1. L2 헬스 체크 : ARP 응답 확인 (디폴트로 ICMP 주기의 10배 자동 설정)
- LAN 전체에 브로드 캐스트를 하여 응답이 있는 포트로 전송한다. 살아있는 서버로 전송을 재게

2. L3 헬스 체크 : Ping 응답 확인
- ping을 활용하여 서버의 응답을 확인하고 접속 가능 여부를 체크

3. L4 헬스 체크 : 서버에 TCP/UDP 서비스 포트가 활성화 되어 있는지 확인
- 바인딩된 장비의 서버 포트로 SYN를 전송하여 응답이 오는지를 확인하고 응답이 없다면 서버의 문제를 인식하고 바인딩 하지 않는 방식이다.
- 응답이 없을 경우 세션을 끊기 때문에 소켓의 낭비를 막을 수 있다.
- 실제 서비스 어플리케이션은 체크 할 수 없는 문제점이 있다.
	
4. L7 헬스 체크 : 어플리케이션에 지속적 접근으로 올바르게 작동하고 있는 지 확인
- L7은 직접 어플리케이션에 접속함으로 서비스가 안정적으로 동작하고 있는지 확인할 수 있기에 많은 서비스에서 활용되고 있다.
- 서버와 TCP 세션을 맺은 상태에서 Request를 통해 응답 코드를 확인하는 방식
- 주기적으로 어플리케이션에 접근해 상태를 체크하는 방식으로 서비스가 보다 안정적으로 동작하게 함
- 주기적으로 서버와 세션을 맺기 때문에 부하가 있을 수 있다.

참조 : http://tech.kakao.com/2014/05/30/l4/
http://tech.kakao.com/2014/05/28/l3dsr/
